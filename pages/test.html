<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª - Ø¯Ø±Ø¹ Ø§Ù„Ø¹ÙØ§Ù</title>
    <link rel="stylesheet" href="../css/pages.css">
    <style>
        .test-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .test-button {
            background: #2ecc71;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .test-button:hover {
            background: #27ae60;
        }
        .test-button.danger {
            background: #e74c3c;
        }
        .test-button.danger:hover {
            background: #c0392b;
        }
        .result {
            margin: 10px 0;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #2ecc71;
            background: #f8f9fa;
        }
        .result.blocked {
            background: #ffe6e6;
            border-left-color: #e74c3c;
        }
        .result.safe {
            background: #e6ffe6;
            border-left-color: #2ecc71;
        }
        .result.error {
            background: #fff3cd;
            border-left-color: #ffc107;
        }
        .domain-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin: 10px 0;
            background: #f9f9f9;
            border-radius: 5px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #2ecc71;
        }
        .stat-label {
            font-size: 14px;
            color: #6c757d;
            margin-top: 5px;
        }
        .log-container {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin: 20px 0;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
        }
        .header h1 {
            margin: 0;
            font-size: 28px;
        }
        .header p {
            margin: 10px 0 0 0;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="header">
            <h1>ğŸ§ª Ø§Ø®ØªØ¨Ø§Ø± Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h1>
            <p>Ø¯Ø±Ø¹ Ø§Ù„Ø¹ÙØ§Ù - Ø­Ù…Ø§ÙŠØ© Ù…ØªÙ‚Ø¯Ù…Ø© Ù…Ù† Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¶Ø§Ø±</p>
        </div>
        
        <div class="stats-grid" id="statsGrid">
            <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¤Ù‡Ø§ Ø¨Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
        </div>

        <div class="test-section">
            <h3>ğŸ” Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª</h3>
            <label for="domainInput">Ø£Ø¯Ø®Ù„ Ø§Ù„Ù†Ø·Ø§Ù‚ Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±:</label>
            <input type="text" id="domainInput" class="test-input" placeholder="Ù…Ø«Ø§Ù„: best.pornktube.com" value="best.pornktube.com">
            <button onclick="testDomain()" class="test-button">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø·Ø§Ù‚</button>
            <button onclick="testNavigation()" class="test-button danger">Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªÙ†Ù‚Ù„</button>
        </div>

        <div class="test-section">
            <h3>âš¡ Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª Ø³Ø±ÙŠØ¹Ø©</h3>
            <button onclick="testPredefinedDomains()" class="test-button">Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙØ© Ù…Ø³Ø¨Ù‚Ø§Ù‹</button>
            <button onclick="getDatabaseInfo()" class="test-button">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button onclick="reloadDatabase()" class="test-button">Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            <button onclick="clearResults()" class="test-button">Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬</button>
        </div>

        <div id="results"></div>
        
        <div class="log-container" id="logContainer">
            <div>=== Ø³Ø¬Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ===</div>
        </div>
    </div>

    <script src="../js/storage-manager.js"></script>
    <script>
        const predefinedDomains = [
            'best.pornktube.com',
            'www.pornktube.com',
            'pornktube.com',
            'sub.pornktube.com',
            'test.pornhub.com',
            'www.xvideos.com',
            'xvideos.com',
            'xnxx.com',
            'xhamster.com',
            'youporn.com',
            'redtube.com',
            'google.com',
            'youtube.com',
            'facebook.com'
        ];

        let storageManager;

        // ØªÙ‡ÙŠØ¦Ø© Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ®Ø²ÙŠÙ†
        async function initStorage() {
            try {
                storageManager = new StorageManager();
                await storageManager.init();
                log('ØªÙ… ØªÙ‡ÙŠØ¦Ø© Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                log(`Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Ù…Ø¯ÙŠØ± Ø§Ù„ØªØ®Ø²ÙŠÙ†: ${error.message}`);
            }
        }

        function log(message) {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            logContainer.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        async function testDomain() {
            const domain = document.getElementById('domainInput').value;
            if (!domain) return;

            log(`Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø·Ø§Ù‚: ${domain}`);

            try {
                const response = await chrome.runtime.sendMessage({
                    action: 'testDomain',
                    domain: domain
                });

                displayResult(domain, response);
                log(`Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${response.isBlocked ? 'Ù…Ø­Ø¸ÙˆØ±' : 'Ø¢Ù…Ù†'}`);
            } catch (error) {
                console.error('Error testing domain:', error);
                displayResult(domain, { error: error.message });
                log(`Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±: ${error.message}`);
            }
        }

        async function testNavigation() {
            const domain = document.getElementById('domainInput').value;
            if (!domain) return;

            log(`Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªÙ†Ù‚Ù„ Ø¥Ù„Ù‰: ${domain}`);

            try {
                const url = `https://${domain}`;
                const response = await chrome.runtime.sendMessage({
                    action: 'testDomain',
                    domain: domain
                });

                if (response.isBlocked) {
                    log(`ğŸš« Ø³ÙŠØªÙ… Ø­Ø¸Ø± Ø§Ù„ØªÙ†Ù‚Ù„ Ø¥Ù„Ù‰: ${url}`);
                } else {
                    log(`âœ… Ø§Ù„ØªÙ†Ù‚Ù„ Ø¢Ù…Ù† Ø¥Ù„Ù‰: ${url}`);
                }

                displayResult(domain, response);
            } catch (error) {
                console.error('Error testing navigation:', error);
                log(`Ø®Ø·Ø£ ÙÙŠ Ù…Ø­Ø§ÙƒØ§Ø© Ø§Ù„ØªÙ†Ù‚Ù„: ${error.message}`);
            }
        }

        async function testPredefinedDomains() {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<h3>Ù†ØªØ§Ø¦Ø¬ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙØ© Ù…Ø³Ø¨Ù‚Ø§Ù‹:</h3>';
            
            log('Ø¨Ø¯Ø¡ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙØ© Ù…Ø³Ø¨Ù‚Ø§Ù‹...');

            for (const domain of predefinedDomains) {
                try {
                    const response = await chrome.runtime.sendMessage({
                        action: 'testDomain',
                        domain: domain
                    });

                    displayResult(domain, response);
                    log(`${domain}: ${response.isBlocked ? 'Ù…Ø­Ø¸ÙˆØ±' : 'Ø¢Ù…Ù†'}`);
                } catch (error) {
                    displayResult(domain, { error: error.message });
                    log(`${domain}: Ø®Ø·Ø£ - ${error.message}`);
                }
                
                // ØªØ£Ø®ÙŠØ± ØµØºÙŠØ± Ø¨ÙŠÙ† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            log('Ø§Ù†ØªÙ‡Ù‰ Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙØ© Ù…Ø³Ø¨Ù‚Ø§Ù‹');
        }

        async function getDatabaseInfo() {
            try {
                const response = await chrome.runtime.sendMessage({
                    action: 'getDatabaseInfo'
                });

                updateStatsGrid(response);
                
                const resultsDiv = document.getElementById('results');
                resultsDiv.innerHTML = `
                    <h3>Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:</h3>
                    <div class="result">
                        <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©:</strong> ${response.adultDomainsCount}</p>
                        <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©:</strong> ${response.adultKeywordsCount}</p>
                        <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¢Ù…Ù†Ø©:</strong> ${response.safeSitesCount}</p>
                        <p><strong>Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…ÙØ¹Ù„Ø©:</strong> ${response.isEnabled ? 'Ù†Ø¹Ù…' : 'Ù„Ø§'}</p>
                    </div>
                `;
                
                log(`ØªÙ… ØªØ­Ù…ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${response.adultDomainsCount} Ù†Ø·Ø§Ù‚ Ù…Ø­Ø¸ÙˆØ±`);
            } catch (error) {
                console.error('Error getting database info:', error);
                log(`Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`);
            }
        }

        async function reloadDatabase() {
            try {
                log('Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
                const response = await chrome.runtime.sendMessage({
                    action: 'reloadDatabase'
                });
                
                if (response.success) {
                    log('âœ… ØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
                    await getDatabaseInfo(); // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
                } else {
                    log('âŒ ÙØ´Ù„ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
                }
            } catch (error) {
                console.error('Error reloading database:', error);
                log(`Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ${error.message}`);
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            document.getElementById('logContainer').innerHTML = '<div>=== Ø³Ø¬Ù„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±Ø§Øª ===</div>';
            log('ØªÙ… Ù…Ø³Ø­ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ§Ù„Ø³Ø¬Ù„');
        }

        function updateStatsGrid(data) {
            const statsGrid = document.getElementById('statsGrid');
            statsGrid.innerHTML = `
                <div class="stat-card">
                    <div class="stat-number">${data.adultDomainsCount}</div>
                    <div class="stat-label">Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.adultKeywordsCount}</div>
                    <div class="stat-label">Ø§Ù„ÙƒÙ„Ù…Ø§Øª Ø§Ù„Ù…ÙØªØ§Ø­ÙŠØ©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.safeSitesCount}</div>
                    <div class="stat-label">Ø§Ù„Ù…ÙˆØ§Ù‚Ø¹ Ø§Ù„Ø¢Ù…Ù†Ø©</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${data.isEnabled ? 'âœ…' : 'âŒ'}</div>
                    <div class="stat-label">Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ù…ÙØ¹Ù„Ø©</div>
                </div>
            `;
        }

        function displayResult(domain, response) {
            const resultsDiv = document.getElementById('results');
            
            if (response.error) {
                resultsDiv.innerHTML += `
                    <div class="result error">
                        <h4>${domain}</h4>
                        <p style="color: red;">Ø®Ø·Ø£: ${response.error}</p>
                    </div>
                `;
                return;
            }

            const isBlocked = response.isBlocked;
            const resultClass = isBlocked ? 'blocked' : 'safe';
            const statusText = isBlocked ? 'ğŸš« Ù…Ø­Ø¸ÙˆØ±' : 'âœ… Ø¢Ù…Ù†';

            resultsDiv.innerHTML += `
                <div class="result ${resultClass}">
                    <h4>${domain} - ${statusText}</h4>
                    <p><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> ${isBlocked ? 'Ù…Ø­Ø¸ÙˆØ±' : 'Ø¢Ù…Ù†'}</p>
                    <p><strong>Ø¹Ø¯Ø¯ Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©:</strong> ${response.adultDomainsCount}</p>
                    ${response.matchingDomains && response.matchingDomains.length > 0 ? 
                        `<p><strong>Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©:</strong></p>
                         <div class="domain-list">
                             ${response.matchingDomains.map(d => `<div>â€¢ ${d}</div>`).join('')}
                         </div>` : 
                        '<p><strong>Ø§Ù„Ù†Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©:</strong> Ù„Ø§ ØªÙˆØ¬Ø¯</p>'
                    }
                </div>
            `;
        }

        // Ø§Ø®ØªØ¨Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('load', async () => {
            log('ØªÙ… ØªØ­Ù…ÙŠÙ„ ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±');
            await initStorage();
            getDatabaseInfo();
        });
    </script>
</body>
</html> 